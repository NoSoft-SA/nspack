# frozen_string_literal: true

# What this script does:
# ----------------------
# updates missing personnel_identifier_id and contract_worker_id on cartons and carton_labels from log files
# This (second) part is for cartons created from URLs that did not include the identifier.
# The identifier has been inferred from a combination of device and time.
#
# Reason for this script:
# -----------------------
# A missing environment variable resulted in personnel identifies not being recorded.
#
# To run:
# -------
# Debug : DEBUG=y RACK_ENV=production ruby scripts/base_script.rb UdFixMissingIncentivesPart2
# Live  : RACK_ENV=production ruby scripts/base_script.rb UdFixMissingIncentivesPart2
# Dev   : ruby scripts/base_script.rb UdFixMissingIncentivesPart2
#
class UdFixMissingIncentivesPart2 < BaseScript
  require 'csv'

  def run
    updates = calculate_updates

    unless debug_mode
      DB.transaction do
        updates.each do |carton_label_id, carton_id, _, identifier_id, contract_worker_id|
          DB[:carton_labels].where(id: carton_label_id).update(personnel_identifier_id: identifier_id, contract_worker_id: contract_worker_id)
          DB[:cartons].where(id: carton_id).update(personnel_identifier_id: identifier_id, contract_worker_id: contract_worker_id) unless carton_id.nil?
        end
      end
    end

    info_dump(updates)
    success_response('Completed update.')
  rescue Crossbeams::InfoError => e
    failed_response(e.message)
  end

  def calculate_updates # rubocop:disable Metrics/AbcSize
    upd = []
    data = File.read(__FILE__) =~ /^__END__\n/ && $' || ''
    CSV.parse(data, headers: true).each do |row|
      # next if row['identifier'] == 'NONE' # Some requests came through without identifier

      identifier = row['identifier'] # .rjust(13, '0') # csv turned 0000447190994 into 447190994 (as numeric)
      identifier_id = DB[:personnel_identifiers].where(identifier: identifier).get(:id)
      raise Crossbeams::InfoError, "Identifier: #{identifier} not found" if identifier_id.nil?

      contract_worker_id = DB[:contract_workers].where(personnel_identifier_id: identifier_id).get(:id)
      raise Crossbeams::InfoError, "There is no Contract worker with identifier_id #{identifier_id} (identifier: #{row['identifier']})" if contract_worker_id.nil?

      upd << [row['carton_label_id'], row['carton_id'], identifier, identifier_id, contract_worker_id]
    end
    upd
  end

  def info_dump(updates) # rubocop:disable Metrics/AbcSize
    fmt_upd = updates.map do |upd|
      "#{upd[0].to_s.rjust(16)} | #{upd[1].to_s.rjust(16)} | #{upd[2].to_s.rjust(16)} | #{upd[3].to_s.rjust(16)} | #{upd[4].to_s.rjust(16)}"
    end

    infodump = <<~STR
      Script: UdFixMissingIncentivesPart2

      What this script does:
      ----------------------
      updates missing  personnel_identifier_id and contract_worker_id on cartons and carton_labels from log files

      This (second) part is for cartons created from URLs that did not include the identifier.
      The identifier has been inferred from a combination of device and time.

      Reason for this script:
      -----------------------
      A missing environment variable resulted in personnel identifies not being recorded.

      Results:
      --------

       carton_label_id |        carton_id |    identifier    | p. identifier_id | contr. worker_id
      -----------------+------------------+------------------+------------------+-----------------
      #{fmt_upd.join("\n")}
      ---
    STR

    log_infodump(:data_fix,
                 :ud,
                 :fix_missing_incentives_2,
                 infodump)
  end
end
__END__
carton_label_id,carton_id,system_resource_code,lbl_created,ctn_created,identifier
6247251,,CLM-0311-B1,2020-08-20 17:48:58.468092,,0000447216677
6247253,,CLM-0311-B1,2020-08-20 17:48:59.665689,,0000447216677
6247255,,CLM-0311-B1,2020-08-20 17:49:00.906029,,0000447216677
6247257,,CLM-0311-B1,2020-08-20 17:49:02.137546,,0000447216677
6247259,,CLM-0311-B1,2020-08-20 17:49:03.369946,,0000447216677
6247442,,CLM-0340-B1,2020-08-20 17:57:08.836004,,0000419035940
6247443,,CLM-0340-B1,2020-08-20 17:57:09.32526,,0000419035940
6247444,,CLM-0340-B1,2020-08-20 17:57:10.05145,,0000419035940
6247445,,CLM-0340-B1,2020-08-20 17:57:10.569054,,0000419035940
6247446,,CLM-0340-B1,2020-08-20 17:57:11.302041,,0000419035940
6247447,,CLM-0340-B1,2020-08-20 17:57:11.810283,,0000419035940
6247448,,CLM-0340-B1,2020-08-20 17:57:12.567132,,0000419035940
6247449,,CLM-0340-B1,2020-08-20 17:57:13.051101,,0000419035940
6247450,,CLM-0340-B1,2020-08-20 17:57:13.801403,,0000419035940
6247451,,CLM-0340-B1,2020-08-20 17:57:14.283211,,0000419035940
6247637,,CLM-0333-B1,2020-08-20 18:02:53.478387,,0000419039061
6247639,,CLM-0333-B1,2020-08-20 18:02:54.689312,,0000419039061
6247641,,CLM-0333-B1,2020-08-20 18:02:55.929109,,0000419039061
6247642,,CLM-0333-B1,2020-08-20 18:02:57.167743,,0000419039061
6247643,,CLM-0333-B1,2020-08-20 18:02:58.411179,,0000419039061
6247666,,CLM-0335-B1,2020-08-20 18:03:31.687791,,0000419034024
6247667,,CLM-0335-B1,2020-08-20 18:03:32.203662,,0000419034024
6247668,,CLM-0335-B1,2020-08-20 18:03:32.89479,,0000419034024
6247669,,CLM-0335-B1,2020-08-20 18:03:33.417173,,0000419034024
6247670,,CLM-0335-B1,2020-08-20 18:03:34.144092,,0000419034024
6247671,,CLM-0335-B1,2020-08-20 18:03:34.647477,,0000419034024
6247672,,CLM-0335-B1,2020-08-20 18:03:35.366808,,0000419034024
6247673,,CLM-0335-B1,2020-08-20 18:03:35.909917,,0000419034024
6247674,,CLM-0335-B1,2020-08-20 18:03:36.615269,,0000419034024
6247675,,CLM-0335-B1,2020-08-20 18:03:37.136226,,0000419034024
6247681,,CLM-0210-B1,2020-08-20 18:04:16.229145,,0000389899855
6247682,,CLM-0210-B1,2020-08-20 18:04:17.390869,,0000389899855
6247683,,CLM-0210-B1,2020-08-20 18:04:18.571807,,0000389899855
6247684,2335238,CLM-0210-B1,2020-08-20 18:04:19.752751,2020-08-20 19:06:09.530638,0000389899855
6247685,2335118,CLM-0210-B1,2020-08-20 18:04:20.940032,2020-08-20 18:12:18.167192,0000389899855
6247772,2335165,CLM-0217-B1,2020-08-20 18:06:02.239247,2020-08-20 19:03:37.817458,0000447214652
6247773,2335166,CLM-0217-B1,2020-08-20 18:06:03.397862,2020-08-20 19:03:40.494065,0000447214652
6247774,2335163,CLM-0217-B1,2020-08-20 18:06:04.596264,2020-08-20 19:03:35.089497,0000447214652
6247775,2335160,CLM-0217-B1,2020-08-20 18:06:05.792526,2020-08-20 19:03:32.184197,0000447214652
6247776,2335168,CLM-0217-B1,2020-08-20 18:06:06.975446,2020-08-20 19:03:43.954106,0000447214652
6247829,2336021,CLM-0207-B1,2020-08-20 18:07:32.026198,2020-08-20 19:46:47.771774,0000411373033
6247832,2336029,CLM-0207-B1,2020-08-20 18:07:33.278513,2020-08-20 19:47:01.347918,0000411373033
6247835,2335236,CLM-0207-B1,2020-08-20 18:07:34.533208,2020-08-20 19:06:07.299103,0000411373033
6247839,2336037,CLM-0207-B1,2020-08-20 18:07:35.965155,2020-08-20 19:47:09.33091,0000411373033
6247843,2336040,CLM-0207-B1,2020-08-20 18:07:37.191472,2020-08-20 19:47:12.514777,0000411373033
6247860,,CLM-0342-B4,2020-08-20 18:08:42.20495,,0000451577990
6247864,,CLM-0342-B4,2020-08-20 18:08:43.452444,,0000451577990
6247869,,CLM-0342-B4,2020-08-20 18:08:44.710048,,0000451577990
6247874,,CLM-0342-B4,2020-08-20 18:08:45.941423,,0000451577990
6247878,,CLM-0342-B4,2020-08-20 18:08:47.416174,,0000451577990
6248104,,CLM-0342-B4,2020-08-20 18:51:39.039412,,0000451577990
6248105,,CLM-0342-B4,2020-08-20 18:51:40.255435,,0000451577990
6248106,,CLM-0342-B4,2020-08-20 18:51:41.480959,,0000451577990
6248107,,CLM-0342-B4,2020-08-20 18:51:42.695843,,0000451577990
6248108,,CLM-0342-B4,2020-08-20 18:51:43.905443,,0000451577990
6248196,2335718,CLM-0204-B1,2020-08-20 19:01:13.616925,2020-08-20 19:29:49.53455,0000411699415
6248548,,CLM-0218-B1,2020-08-20 19:05:53.617104,,0000398543179
6248550,,CLM-0218-B1,2020-08-20 19:05:54.771247,,0000398543179
6248551,,CLM-0218-B1,2020-08-20 19:05:55.970628,,0000398543179
6248552,,CLM-0218-B1,2020-08-20 19:05:57.154989,,0000398543179
6248553,,CLM-0218-B1,2020-08-20 19:05:58.325697,,0000398543179
6248585,,CLM-0209-B1,2020-08-20 19:06:11.128896,,0000419023475
6248588,,CLM-0209-B1,2020-08-20 19:06:12.304836,,0000419023475
6248591,2336112,CLM-0209-B1,2020-08-20 19:06:13.483849,2020-08-20 19:50:11.567632,0000419023475
6248595,,CLM-0209-B1,2020-08-20 19:06:14.675234,,0000419023475
6248657,2335653,CLM-0217-B1,2020-08-20 19:06:42.561975,2020-08-20 19:24:05.074092,0000451645585
6248665,2335637,CLM-0217-B1,2020-08-20 19:06:43.71796,2020-08-20 19:23:48.553101,0000451645585
6248670,2335531,CLM-0217-B1,2020-08-20 19:06:44.905347,2020-08-20 19:17:33.110828,0000451645585
6248674,,CLM-0217-B1,2020-08-20 19:06:46.108912,,0000451645585
6248679,2335430,CLM-0217-B1,2020-08-20 19:06:47.279296,2020-08-20 19:14:19.353867,0000451645585
6248892,,CLM-0217-B1,2020-08-20 19:08:12.927166,,0000419040731
6248895,,CLM-0217-B1,2020-08-20 19:08:14.073784,,0000419040731
6248897,,CLM-0217-B1,2020-08-20 19:08:15.261329,,0000419040731
6248899,2335562,CLM-0217-B1,2020-08-20 19:08:16.442134,2020-08-20 19:18:13.781048,0000419040731
6248901,2335520,CLM-0217-B1,2020-08-20 19:08:17.615259,2020-08-20 19:17:21.73408,0000419040731
6248907,2335956,CLM-0234-B1,2020-08-20 19:08:27.924489,2020-08-20 19:43:02.174767,0000447208195
6248911,2335753,CLM-0234-B1,2020-08-20 19:08:29.079419,2020-08-20 19:30:55.775388,0000447208195
6248915,2335750,CLM-0234-B1,2020-08-20 19:08:30.273968,2020-08-20 19:30:52.799006,0000447208195
6248917,,CLM-0320-B1,2020-08-20 19:08:31.172244,,0000419051030
6248919,2335751,CLM-0234-B1,2020-08-20 19:08:31.457573,2020-08-20 19:30:53.60722,0000447208195
6248921,2336185,CLM-0320-B1,2020-08-20 19:08:32.419856,2020-08-20 20:04:35.664274,0000419051030
6248923,2335509,CLM-0234-B1,2020-08-20 19:08:32.646736,2020-08-20 19:16:30.16751,0000419051030
6248925,2335494,CLM-0320-B1,2020-08-20 19:08:33.681476,2020-08-20 19:16:00.534024,0000419051030
6248926,2335472,CLM-0320-B1,2020-08-20 19:08:34.679976,2020-08-20 19:15:26.630138,0000419051030
6248927,2335457,CLM-0320-B1,2020-08-20 19:08:34.912275,2020-08-20 19:15:01.922858,0000419051030
6248929,2335373,CLM-0320-B1,2020-08-20 19:08:35.888149,2020-08-20 19:13:15.929341,0000419051030
6248930,2335367,CLM-0320-B1,2020-08-20 19:08:36.185252,2020-08-20 19:12:59.253317,0000419051030
6248932,2335357,CLM-0320-B1,2020-08-20 19:08:37.126683,2020-08-20 19:12:15.974082,0000419051030
6248934,2335349,CLM-0320-B1,2020-08-20 19:08:38.357895,2020-08-20 19:11:44.471341,0000419051030
6248937,2335331,CLM-0320-B1,2020-08-20 19:08:39.599315,2020-08-20 19:11:16.314731,0000419051030
6248939,2335827,CLM-0214-B1,2020-08-20 19:08:40.025851,2020-08-20 19:36:56.441962,0000464647713
6248941,2335785,CLM-0214-B1,2020-08-20 19:08:41.204034,2020-08-20 19:34:39.785576,0000464647713
6248943,2335560,CLM-0214-B1,2020-08-20 19:08:42.3829,2020-08-20 19:18:11.326392,0000464647713
6248945,2335706,CLM-0214-B1,2020-08-20 19:08:42.946509,2020-08-20 19:27:58.205582,0000464647713
6248946,2335660,CLM-0214-B1,2020-08-20 19:08:43.565589,2020-08-20 19:24:14.252603,0000464647713
6248948,2335439,CLM-0214-B1,2020-08-20 19:08:44.125002,2020-08-20 19:14:29.723504,0000464647713
6248949,2335442,CLM-0214-B1,2020-08-20 19:08:44.741208,2020-08-20 19:14:33.275065,0000464647713
6248950,2335441,CLM-0214-B1,2020-08-20 19:08:45.311984,2020-08-20 19:14:31.884068,0000464647713
6248951,2335440,CLM-0214-B1,2020-08-20 19:08:46.486978,2020-08-20 19:14:30.515032,0000464647713
6248954,2335437,CLM-0214-B1,2020-08-20 19:08:47.662293,2020-08-20 19:14:27.900993,0000464647713
6248959,,CLM-0214-B4,2020-08-20 19:08:49.658824,,0000464647713
6248962,,CLM-0214-B4,2020-08-20 19:08:50.805556,,0000464647713
6248967,,CLM-0214-B4,2020-08-20 19:08:52.03741,,0000464647713
6248968,,CLM-0214-B4,2020-08-20 19:08:52.868036,,0000464647713
6248983,2335502,CLM-0328-B1,2020-08-20 19:08:57.007404,2020-08-20 19:16:19.114324,0000451669470
6248985,2335490,CLM-0328-B1,2020-08-20 19:08:58.24857,2020-08-20 19:15:54.701849,0000451669470
6248987,2335475,CLM-0328-B1,2020-08-20 19:08:59.502514,2020-08-20 19:15:31.217874,0000451669470
6249120,2335570,CLM-0328-B1,2020-08-20 19:10:40.189886,2020-08-20 19:18:41.243073,0000451669470
6249128,2335544,CLM-0328-B1,2020-08-20 19:10:43.901745,2020-08-20 19:17:43.900546,0000451669470
6249129,2335539,CLM-0328-B1,2020-08-20 19:10:45.154381,2020-08-20 19:17:39.795072,0000451669470
6249453,,CLM-0335-B4,2020-08-20 19:15:06.360465,,0000447225938
6249455,,CLM-0335-B4,2020-08-20 19:15:07.589644,,0000447225938
6249459,,CLM-0335-B4,2020-08-20 19:15:08.825638,,0000447225938
6249463,,CLM-0335-B4,2020-08-20 19:15:09.789769,,0000447225938
6249631,,CLM-0221-B1,2020-08-20 19:18:44.30024,,0000411377640
6249632,,CLM-0221-B1,2020-08-20 19:18:45.446862,,0000411377640
6249634,2337005,CLM-0221-B1,2020-08-20 19:18:46.624542,2020-08-20 20:50:41.32111,0000411377640
6249636,2337004,CLM-0221-B1,2020-08-20 19:18:47.823578,2020-08-20 20:50:40.426223,0000411377640
6249638,2337002,CLM-0221-B1,2020-08-20 19:18:49.000143,2020-08-20 20:50:34.994012,0000411377640
6249728,2336618,CLM-0340-B1,2020-08-20 19:20:12.724745,2020-08-20 20:29:40.81776,0000419035940
6249733,2336518,CLM-0340-B1,2020-08-20 19:20:13.934652,2020-08-20 20:19:35.943174,0000419035940
6249738,2336517,CLM-0340-B1,2020-08-20 19:20:15.183123,2020-08-20 20:19:34.084475,0000419035940
6249741,2336516,CLM-0340-B1,2020-08-20 19:20:16.423972,2020-08-20 20:19:32.253672,0000419035940
6249744,2336515,CLM-0340-B1,2020-08-20 19:20:17.661535,2020-08-20 20:19:30.425865,0000419035940
6249749,2336514,CLM-0340-B1,2020-08-20 19:20:22.401638,2020-08-20 20:19:28.849202,0000419035940
6249750,2336513,CLM-0340-B1,2020-08-20 19:20:22.891441,2020-08-20 20:19:27.269791,0000419035940
6249751,2336511,CLM-0340-B1,2020-08-20 19:20:23.377214,2020-08-20 20:19:25.521032,0000419035940
6249752,2336508,CLM-0340-B1,2020-08-20 19:20:23.613816,2020-08-20 20:19:21.956444,0000419035940
6249753,2336498,CLM-0340-B1,2020-08-20 19:20:24.101168,2020-08-20 20:17:44.001992,0000419035940
6249754,2336488,CLM-0340-B1,2020-08-20 19:20:24.608821,2020-08-20 20:17:25.15297,0000419035940
6249755,2336435,CLM-0340-B1,2020-08-20 19:20:24.849947,2020-08-20 20:13:44.307526,0000419035940
6249756,2336336,CLM-0340-B1,2020-08-20 19:20:25.328929,2020-08-20 20:08:26.223908,0000419035940
6249758,2336329,CLM-0340-B1,2020-08-20 19:20:25.842654,2020-08-20 20:08:11.880696,0000419035940
6249759,2336510,CLM-0340-B1,2020-08-20 19:20:26.082312,2020-08-20 20:19:23.747891,0000419035940
6249760,2336505,CLM-0340-B1,2020-08-20 19:20:26.584489,2020-08-20 20:19:19.610284,0000419035940
6249762,2336494,CLM-0340-B1,2020-08-20 19:20:27.080266,2020-08-20 20:17:33.636551,0000419035940
6249764,2336470,CLM-0340-B1,2020-08-20 19:20:27.833027,2020-08-20 20:15:11.455182,0000419035940
6249766,2336439,CLM-0340-B1,2020-08-20 19:20:28.313675,2020-08-20 20:13:53.876862,0000419035940
