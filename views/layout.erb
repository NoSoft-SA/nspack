<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <%= csrf_metatag %>

    <title><%= ENV['APP_CAPTION'] %></title>

    <!-- FAVICON start -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <!-- FAVICON end -->

    <link rel="stylesheet" href="/css/jackbox.css">
    <link rel="stylesheet" href="/css/tachyons.min.css">
    <link rel="stylesheet" href="/css/sweetalert2.min.css">
    <link rel="stylesheet" href="/css/jquery.contextMenu.min.css">
    <link rel="stylesheet" href="/css/menu.css?seq=1">
    <link rel="stylesheet" href="/css/skin.css?seq=1">
    <link rel="stylesheet" href="/css/choices.min.css">
    <link rel="stylesheet" href="/css/multi.min.css">
    <%= assets(:css) %>
    <%= content_for :late_style %>

    <style>
      @media ( max-width: 40rem ) {
        #menuSearch { display: none }
        .container {
          margin-top: 15px;
        }
        div.functional-area-menu {
          margin-top: 25px;
          white-space: nowrap; /* [1] */
          overflow-x: auto; /* [2] */
          -webkit-overflow-scrolling: touch; /* [3] */
          -ms-overflow-style: -ms-autohiding-scrollbar; /* [4] */
          background-color: #3A5974;
        }

        #functional-area-menu {
          list-style-type: none;
          margin: 0;
          padding: 0;
        }
        .menu-prog-selected {
          background: none;
        }
        /*
        li.-hasSubmenu a {
        color: orange;
        border-bottom: thin solid yellow;
        } */
        .-hasSubmenu {
          list-style: none;
          pointer-events: none;
        }
        #menu #programs-menu a[data-menu-level2] {
          color: orange;
          border-bottom: thin solid orange;
          padding: 10px;
        }
        [data-menu-level3] {
          pointer-events: all;
        }
        #functional-area-menu li {
          display: inline-block;
          color: white;
          padding: 20px 10px;
        }
        #functional-area-menu li a {
          text-decoration: none;
          /* background-color: cornsilk; */
          display: inline-block;
          height: 30px;
          color: white;
        }

        /*
        div.scrollmenu {
        background-color: #333;
        overflow: auto;
        white-space: nowrap;
        }

        div.scrollmenu a {
        display: inline-block;
        color: white;
        text-align: center;
        padding: 14px;
        text-decoration: none;
        }

        div.scrollmenu a:hover {
        background-color: #777;
        }
         */
        /* NAV (MENU) BUTTON */
        #nav button {
          display: block;
          position: absolute;
          top: 25px;
          left: 10px;
          border: 0;
          height: 32px;
          width: 32px;
          background: none;
          color: #107db5;
          font-size: 0rem;
          padding: 0;
          transition: 0.2s 0.5s color ease-in-out;
        }

        #nav button svg {
          display: block;
          pointer-events: none;
          stroke: currentcolor;
          vertical-align: middle;
          height: 32px;
          width: 32px;
          transition: 0.2s 0.5s stroke ease-in-out;
        }

        #nav button::before {
          content: ' ';
          position: absolute;
          border-radius: 200vh;
          opacity: 0;
          left: calc(-130vmax + 50%);
          top: calc(-130vmax + 50%);
          width: 260vmax;
          height: 260vmax;
          background: #107db5;
          display: block;
          z-index: -1;
          transform: scale3d(0, 0, 0);
          transform-origin: 50% 50%;
          transition: 0.5s ease-in-out transform, 0.2s 0.4s ease-in-out opacity;
        }

        #nav button[aria\-expanded=true] {
          color: #fff;
        }

        #nav button[aria\-expanded=true]::before {
          opacity: 1;
          transform: scale3d(1, 1, 1);
          transition: 0.5s ease-in-out transform, 0.1s ease-in-out opacity;
        }

        #menu #programs-menu {
          padding: 0;
        }
        #menu #programs-menu ul {
          /* pointer-events: none; */
          list-style: none;
          width: 100vw;
          /* height: 100vh; */
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: space-around;
          padding: 0;
        }

        #menu #programs-menu a {
          text-decoration: none;
          font-weight: bold;
          color: #fff;
          /* opacity: 0; */
          display: block;
          transform: translateY(-10px);
          transition: 0.2s 0.5s ease-out opacity, 0.2s 0.5s ease-out transform;
          padding: 10px;
        }

        #programs-menu li:nth-child(2) a {
          transition: 0.2s 0.7s ease-out opacity, 0.2s 0.7s ease-out transform;
        }

        #programs-menu li:nth-child(3) a {
          transition: 0.2s 0.9s ease-out opacity, 0.2s 0.9s ease-out transform;
        }

        #programs-menu li:nth-child(4) a {
          transition: 0.2s 1.1s ease-out opacity, 0.2s 1.1s ease-out transform;
        }

        #menu:not([hidden]) {
          pointer-events: all;
        }

        #menu:not([hidden]) a {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media ( min-width: 40rem ) {
        #nav button { display: none }
        #menu { display: block } /* NB: we have important! on [hidden] in styles.css, so this will not work... */
        #menuSearch {
          display: inline-block;
          /* -webkit-appearance: textfield;
          outline-offset: -2px; */
        }
        .container {
          margin-top: 90px;
        }
        /* #menuSearch { display: block } */
      }
    </style>
    <%= content_for :late_head %>
  </head>
  <body class="site" data-utf-8-ensurer="Ðž">
  <header>
    <div class="system-name">
      <a href="/" class="dib f5 f4-ns fw6 mt0 mb2 link mid-gray" title="Home">
        <%= ENV['APP_CAPTION'] %>
        <div class="dib">
          <small class="nowrap f6 mt2 mt3-ns pr2 black-70 fw2">v<%= ENV['VERSION'] %></small>
        </div>
      </a>
    </div>
      <div id="notification-area">
        <% if current_user %>
          <input id="menuSearch" type="search" placeholder="Search menu" />
          <ul id="menuSearchResults">
          </ul>
          <!-- [current resource] -->
          <% if session[:act_as_user_id] %>
            <span class="ml2 mr2 f6 link mb2 br2 ph3 pv2 dib white bg-silver"><%= actor_user.user_name %> acting as <strong><%= current_user.user_name %></strong></span>
          <% else %>
            <a href="/development/masterfiles/users/<%= current_user.id %>/details" class="ml2 mr2 f6 link dim mb2 br2 ph3 pv2 dib white bg-silver" data-popup-dialog= "true"><%= current_user.user_name %></a>
        <% end %>
          <a href="/logout" id="logout" class="f6 fw6 hover-blue link black-70 ml3 mr2 mr3-m mr4-l dib" title="Logout">logout</a>
        <% end %>
      </div>
    <%#= partial 'page_banner' %>
    <%= partial 'menu' %>
</header>
    <div id="container" class="container">
      <% if @documentation_page %>
        <form action="/search_developer_documentation" class="absolute">
          <input id="search_term" type="search" name="search_term" placeholder="Search documentation" />
        </form>
      <% end %>
      <%= yield %>
    </div>

    <div class="dialog" aria-hidden="true" id="crossbeams-popup-dialog-level1">
      <div class="dialog-overlay" tabindex="-1"></div> <!-- data-a11y-dialog-hide></div> -->
      <div id="dialog-error-level1" class="brown bg-washed-red ba b--light-red absolute top-1 left-1 pa3" style="display:none;z-index:60;min-width:20em;"></div>
      <div class="dialog-content" aria-labelledby="dialogTitleLevel1" role="dialog">
        <div role="document">
          <button data-a11y-dialog-hide class="dialog-close" aria-label="Close this dialog window">&times;</button>
          <h1 id="dialogTitleLevel1">Dialog title</h1>
          <div id="dialog-content-level1"></div>
        </div>
      </div>
    </div>

    <div class="dialog" aria-hidden="true" id="crossbeams-popup-dialog-level2">
      <div class="dialog-overlay" tabindex="-1"></div> <!-- data-a11y-dialog-hide></div> -->
      <div id="dialog-error-level2" class="brown bg-washed-red ba b--light-red absolute top-1 left-1 pa3" style="display:none;z-index:60;min-width:20em;"></div>
      <div class="dialog-content" aria-labelledby="dialogTitleLevel2" role="dialog">
        <div role="document">
          <button data-a11y-dialog-hide class="dialog-close" aria-label="Close this dialog window">&times;</button>
          <h1 id="dialogTitleLevel2">Dialog title</h1>
          <div id="dialog-content-level2"></div>
        </div>
      </div>
    </div>

    <footer class="footness">
      <p>NOSOFT 2017
        <% if ENV['RACK_ENV'] == 'development' %>
          <% asset_type = assets_paths(:css).any? { |p| p.include?('scss') } ? :bug : :show %>
          ASSETS: <%= Crossbeams::Layout::Icon.new(asset_type).render %>
        <% end %>
    </footer>

    <% if @label_edit_page %>
      <script src="/js/konva.min.js?seq=1"></script>
    <% else %>
      <script src="/js/ag-grid-enterprise.min.js?seq=2"></script>
      <script src="/js/ag-enterprise-activation.js?seq=1"></script>
  <% end %>

    <script src="/js/jackbox.min.js"></script>
    <script src="/js/jquery-3.2.1.min.js"></script>
    <script src="/js/jquery.ui.position.min.js"></script>
    <script src="/js/jquery.contextMenu.min.js"></script>
    <script src="/js/sweetalert2.min.js"></script>
    <script src="/js/Sortable.min.js"></script>
    <script src="/js/svg-inject.min.js"></script>
    <script src="/js/crossbeams-local-storage.js"></script>
    <script src="/js/crossbeams-utils.js?seq=13"></script>
    <script src="/js/crossbeams-layout.js?seq=11"></script>
    <script src="/js/crossbeams-grid-loader.js?seq=18"></script>
    <script src="/js/crossbeams-data-miner-params.js?seq=1"></script>
    <script src="/js/crossbeams-menu-builder.js?seq=1"></script>
    <script src="/js/choices.min.js"></script>
    <script src="/js/multi.min.js"></script>
    <script src="/js/a11y-dialog-cbeam.js"></script>
    <script src="/js/message-bus.js"></script>
    <script src="/js/message-bus-ajax.js"></script>
    <script>
      let crossbeamsDialogLevel1;
      let crossbeamsDialogLevel2;

      document.addEventListener('DOMContentLoaded', function () {
        const dialogEl1 = document.getElementById('crossbeams-popup-dialog-level1');
        crossbeamsDialogLevel1 = new window.A11yDialog(dialogEl1);
        const dialogEl2 = document.getElementById('crossbeams-popup-dialog-level2');
        crossbeamsDialogLevel2 = new window.A11yDialog(dialogEl2);

        const sortable = Array.from(document.getElementsByTagName('input')).filter(a => a.dataset && a.dataset.sortablePrefix);
        sortable.forEach((elem) => crossbeamsUtils.makeListSortable(elem.dataset.sortablePrefix, elem.dataset.sortableGroup))

      });

      // Build the menu.
      crossbeamsMenuBuilder.buildMenu(<%= menu_items(self.class.name) %>);

      Jackbox.init();
      <% if flash[:notice] %>
        Jackbox.success('<%= flash[:notice].tr("'", "`") %>');
      <% end %>
      <% if flash[:error] %>
        Jackbox.error('<%= flash[:error].tr("'", "`") %>', { time: 20 });
      <% end %>

      // MessageBus handling --- START
      MessageBus.baseUrl = "/terminus/";
      const logged_in_user = '<%= current_user ? current_user.login_name : "unknown" %>';

      MessageBus.subscribe("/terminus", function(msg){
        console.log('MSG', msg);
        if (msg.targetUser && msg.targetUser !== 'broadcast' && msg.targetUser !== logged_in_user) {
          return;
        }
        switch (msg.messageType) {
          case 'warning':
            Jackbox.warning(msg.message);
            return;
          case 'error':
            Jackbox.error(msg.message);
            return;
          default:
            Jackbox.information(msg.message);
        }
      });
      // MessageBus handling --- END

      // MENU SHAPING FOR RESPONSIVE CONDITIONS -- START
      const toggleMenu = document.querySelector(".navigation button");
      // const menu = document.querySelector(".navigation ul");
      const menu = document.querySelector("#menu");

      toggleMenu.addEventListener("click", function () {
        const open = JSON.parse(toggleMenu.getAttribute("aria-expanded"));
        toggleMenu.setAttribute("aria-expanded", !open);
        menu.hidden = !menu.hidden;
      });

      // Javascript to react to media query change:
      function menuForMinWidth(x) {
        if (x.matches) { // If media query matches
          menu.hidden = false;
        } else {
          menu.hidden = true;
        }
      }

      var min40 = window.matchMedia("(min-width: 40rem)")
      menuForMinWidth(min40) // Call listener function at run time
      min40.addListener(menuForMinWidth) // Attach listener function on state changes
      // MENU SHAPING FOR RESPONSIVE CONDITIONS -- END
    </script>
    <script src="/js/crossbeams-menu-handler.js"></script>
    <%= content_for :late_javascript %>
  </body>
</html>
