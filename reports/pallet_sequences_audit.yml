---
:caption: Pallet Sequences Audit
:sql: "SELECT\r\n    event_id,\r\n    user_name,\r\n    transaction_at,\r\n    action,\r\n
  \   changed_fields,\r\n    pallet_number,\r\n    pallet_sequence_number,\r\n    farms.farm_code,\r\n
  \   pucs.puc_code,\r\n    orchards.orchard_code,\r\n    cultivars.cultivar_code,\r\n
  \   marketing_varieties.marketing_variety_code,\r\n    target_market_groups.target_market_group_name
  AS packed_tm_group,\r\n    standard_pack_codes.standard_pack_code,\r\n    fruit_size_references.size_reference,\r\n
  \   fruit_actual_counts_for_packs.actual_count_for_pack AS actual_count,\r\n    marks.mark_code,\r\n
  \   phyto_data,\r\n    array_agg(orchard_test_types.test_type_code order by orchard_test_types.test_type_code)
  filter (where orchard_test_types.test_type_code is not null) AS failed_otmc_results,\r\n
  \   CASE WHEN action = 'I' THEN\r\n             'blue' -- created\r\n         WHEN
  action = 'U' THEN\r\n             'gray' -- updated\r\n         WHEN action = 'D'
  THEN\r\n             'orange' -- deleted\r\n         WHEN action = 'C' THEN\r\n
  \            'black' -- current\r\n        END AS colour_rule\r\nFROM (\r\n         SELECT\r\n
  \            event_id,\r\n             logged_action_details.user_name,\r\n             action_tstamp_clk
  AS transaction_at,\r\n             action,\r\n             changed_fields,\r\n             row_data
  -> 'pallet_number' AS pallet_number,\r\n             row_data -> 'pallet_sequence_number'
  AS pallet_sequence_number,\r\n             row_data -> 'farm_id' AS farm_id,\r\n
  \            row_data -> 'puc_id' AS puc_id,\r\n             row_data -> 'orchard_id'
  AS orchard_id,\r\n             row_data -> 'cultivar_id' AS cultivar_id,\r\n             row_data
  -> 'marketing_variety_id' AS marketing_variety_id,\r\n             row_data -> 'standard_pack_code_id'
  AS standard_pack_code_id,\r\n             row_data -> 'fruit_size_reference_id'
  AS fruit_size_reference_id,\r\n             row_data -> 'fruit_actual_counts_for_pack_id'
  AS fruit_actual_counts_for_pack_id,\r\n             row_data -> 'mark_id' AS mark_id,\r\n
  \            row_data -> 'production_run_id' AS production_run_id,\r\n             row_data
  -> 'carton_quantity' AS carton_quantity,\r\n             row_data -> 'packed_tm_group_id'
  AS packed_tm_group_id,\r\n             row_data -> 'phyto_data' AS phyto_data,\r\n
  \            row_data -> 'failed_otmc_results' AS failed_otmc_result_ids\r\n         FROM
  audit.logged_actions\r\n         LEFT JOIN audit.logged_action_details ON logged_actions.transaction_id
  = logged_action_details.transaction_id\r\n         WHERE\r\n                 table_name
  = 'pallet_sequences'\r\n         UNION\r\n         SELECT\r\n             999999999
  AS event_id,\r\n             NULL AS user_name,\r\n             NULL AS transaction_at,\r\n
  \            'C' AS action,\r\n             NULL AS changed_fields,\r\n             pallet_number::TEXT
  AS pallet_number,\r\n             pallet_sequence_number::TEXT AS pallet_sequence_number,\r\n
  \            farm_id::TEXT,\r\n             puc_id::TEXT,\r\n             orchard_id::TEXT,\r\n
  \            cultivar_id::TEXT,\r\n             marketing_variety_id::TEXT,\r\n
  \            standard_pack_code_id::TEXT,\r\n             fruit_size_reference_id::TEXT,\r\n
  \            fruit_actual_counts_for_pack_id::TEXT,\r\n             mark_id::TEXT,\r\n
  \            production_run_id::TEXT,\r\n             carton_quantity::TEXT,\r\n
  \            packed_tm_group_id::TEXT,\r\n             phyto_data::TEXT,\r\n             failed_otmc_results::TEXT
  AS failed_otmc_result_ids\r\n         FROM\r\n             pallet_sequences) sq\r\nLEFT
  JOIN farms ON farms.id = sq.farm_id::INT\r\nLEFT JOIN pucs ON pucs.id = sq.puc_id::INT\r\nLEFT
  JOIN orchards ON orchards.id = sq.orchard_id::INT\r\nLEFT JOIN cultivars ON cultivars.id
  = sq.cultivar_id::INT\r\nLEFT JOIN marketing_varieties ON marketing_varieties.id
  = sq.marketing_variety_id::INT\r\nLEFT JOIN target_market_groups ON target_market_groups.id
  = sq.packed_tm_group_id::INT\r\nLEFT JOIN standard_pack_codes ON standard_pack_codes.id
  = sq.standard_pack_code_id::INT\r\nLEFT JOIN fruit_size_references ON fruit_size_references.id
  = sq.fruit_size_reference_id::INT\r\nLEFT JOIN fruit_actual_counts_for_packs ON
  fruit_actual_counts_for_packs.id = sq.fruit_actual_counts_for_pack_id::INT\r\nLEFT
  JOIN marks ON marks.id = sq.mark_id::INT\r\nLEFT JOIN orchard_test_types ON orchard_test_types.id
  = ANY (sq.failed_otmc_result_ids::INT[])\r\n\r\nGROUP BY\r\n    sq.event_id,\r\n
  \   sq.user_name,\r\n    sq.phyto_data,\r\n    sq.transaction_at,\r\n    sq.action,\r\n
  \   sq.changed_fields,\r\n    sq.pallet_number,\r\n    sq.pallet_sequence_number,\r\n
  \   farms.id,\r\n    pucs.id,\r\n    orchards.id,\r\n    cultivars.id,\r\n    marketing_varieties.id,\r\n
  \   target_market_groups.id,\r\n    standard_pack_codes.id,\r\n    fruit_size_references.id,\r\n
  \   fruit_actual_counts_for_packs.id,\r\n    marks.id\r\nORDER BY\r\n    pallet_number
  DESC,\r\n    pallet_sequence_number,\r\n    event_id"
:limit: 
:offset: 
:external_settings:
  :colour_key:
    blue: Created
    gray: Updated
    orange: Deleted
    black: Current
:columns:
  event_id:
    :name: event_id
    :sequence_no: 1
    :caption: Event
    :namespaced_name: event_id
    :data_type: :string
    :width: 
    :format: 
    :hide: true
    :pinned: 
    :groupable: false
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  user_name:
    :name: user_name
    :sequence_no: 2
    :caption: User
    :namespaced_name: user_name
    :data_type: :string
    :width: 150
    :format: 
    :hide: false
    :pinned: 
    :groupable: false
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  transaction_at:
    :name: transaction_at
    :sequence_no: 3
    :caption: Transaction at
    :namespaced_name: transaction_at
    :data_type: :string
    :width: 100
    :format: 
    :hide: false
    :pinned: 
    :groupable: false
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  action:
    :name: action
    :sequence_no: 4
    :caption: Action
    :namespaced_name: action
    :data_type: :string
    :width: 65
    :format: 
    :hide: false
    :pinned: 
    :groupable: false
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  changed_fields:
    :name: changed_fields
    :sequence_no: 5
    :caption: Changed fields
    :namespaced_name: changed_fields
    :data_type: :string
    :width: 200
    :format: 
    :hide: false
    :pinned: 
    :groupable: false
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  pallet_number:
    :name: pallet_number
    :sequence_no: 6
    :caption: Pallet number
    :namespaced_name: pallet_number
    :data_type: :string
    :width: 150
    :format: 
    :hide: false
    :pinned: 
    :groupable: false
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  pallet_sequence_number:
    :name: pallet_sequence_number
    :sequence_no: 7
    :caption: Pallet sequence number
    :namespaced_name: pallet_sequence_number
    :data_type: :string
    :width: 75
    :format: 
    :hide: false
    :pinned: 
    :groupable: false
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  farm_code:
    :name: farm_code
    :sequence_no: 8
    :caption: Farm code
    :namespaced_name: farms.farm_code
    :data_type: :string
    :width: 75
    :format: 
    :hide: false
    :pinned: 
    :groupable: true
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  puc_code:
    :name: puc_code
    :sequence_no: 9
    :caption: Puc code
    :namespaced_name: pucs.puc_code
    :data_type: :string
    :width: 75
    :format: 
    :hide: false
    :pinned: 
    :groupable: true
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  orchard_code:
    :name: orchard_code
    :sequence_no: 10
    :caption: Orchard code
    :namespaced_name: orchards.orchard_code
    :data_type: :string
    :width: 75
    :format: 
    :hide: false
    :pinned: 
    :groupable: true
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  cultivar_code:
    :name: cultivar_code
    :sequence_no: 11
    :caption: Cultivar code
    :namespaced_name: cultivars.cultivar_code
    :data_type: :string
    :width: 75
    :format: 
    :hide: false
    :pinned: 
    :groupable: true
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  marketing_variety_code:
    :name: marketing_variety_code
    :sequence_no: 12
    :caption: Marketing variety code
    :namespaced_name: marketing_varieties.marketing_variety_code
    :data_type: :string
    :width: 75
    :format: 
    :hide: false
    :pinned: 
    :groupable: true
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  packed_tm_group:
    :name: packed_tm_group
    :sequence_no: 13
    :caption: Packed tm group
    :namespaced_name: target_market_groups.target_market_group_name
    :data_type: :string
    :width: 75
    :format: 
    :hide: false
    :pinned: 
    :groupable: false
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  standard_pack_code:
    :name: standard_pack_code
    :sequence_no: 14
    :caption: Standard pack code
    :namespaced_name: standard_pack_codes.standard_pack_code
    :data_type: :string
    :width: 75
    :format: 
    :hide: false
    :pinned: 
    :groupable: true
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  size_reference:
    :name: size_reference
    :sequence_no: 15
    :caption: Size reference
    :namespaced_name: fruit_size_references.size_reference
    :data_type: :string
    :width: 75
    :format: 
    :hide: false
    :pinned: 
    :groupable: true
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  actual_count:
    :name: actual_count
    :sequence_no: 16
    :caption: Actual count
    :namespaced_name: fruit_actual_counts_for_packs.actual_count_for_pack
    :data_type: :string
    :width: 75
    :format: 
    :hide: false
    :pinned: 
    :groupable: false
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  mark_code:
    :name: mark_code
    :sequence_no: 17
    :caption: Mark code
    :namespaced_name: marks.mark_code
    :data_type: :string
    :width: 75
    :format: 
    :hide: false
    :pinned: 
    :groupable: true
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  phyto_data:
    :name: phyto_data
    :sequence_no: 18
    :caption: Phyto data
    :namespaced_name: phyto_data
    :data_type: :string
    :width: 100
    :format: 
    :hide: false
    :pinned: 
    :groupable: false
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  failed_otmc_results:
    :name: failed_otmc_results
    :sequence_no: 19
    :caption: Failed otmc results
    :namespaced_name: 
    :data_type: :string
    :width: 300
    :format: 
    :hide: false
    :pinned: 
    :groupable: false
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
  colour_rule:
    :name: colour_rule
    :sequence_no: 20
    :caption: Colour rule
    :namespaced_name: 
    :data_type: :string
    :width: 
    :format: 
    :hide: true
    :pinned: 
    :groupable: false
    :group_by_seq: 
    :group_sum: false
    :group_avg: false
    :group_min: false
    :group_max: false
:query_parameter_definitions:
- :column: pallet_number
  :caption: Pallet Number
  :data_type: :string
  :control_type: :text
  :default_value: 
  :ordered_list: false
  :ui_priority: 1
  :list_def: 
- :column: pallet_sequence_number
  :caption: Pallet Sequence Number
  :data_type: :string
  :control_type: :text
  :default_value: 
  :ordered_list: false
  :ui_priority: 1
  :list_def: 
